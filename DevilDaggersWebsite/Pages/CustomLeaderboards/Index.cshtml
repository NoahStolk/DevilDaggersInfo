@page
@using DevilDaggersCore.Spawnsets.Web
@using DevilDaggersWebsite.Code.Database.CustomLeaderboards
@using DevilDaggersWebsite.Code.Utils
@using System.Linq
@model DevilDaggersWebsite.Pages.CustomLeaderboards.IndexModel
@{
	ViewData["Title"] = "Custom Leaderboards";
}

<header>
	<h1>@ViewData["Title"]</h1>
</header>

<main role="main">
	<p class="text-center">
		Custom leaderboards are leaderboards for <a asp-page="/Spawnsets">custom spawnsets</a> hosted by DevilDaggers.info. They are still in development.
	</p>

	<table>
		<thead>
			<tr>
				<th width="300">
					Spawnset name
				</th>
				<th width="300">
					Spawnset author
				</th>
				<th class="hidden-xs" width="100">
					Players
				</th>
				<th class="hidden-xs hidden-sm hidden-md" width="100">
					Bronze
				</th>
				<th class="hidden-xs hidden-sm hidden-md" width="100">
					Silver
				</th>
				<th class="hidden-xs hidden-sm hidden-md" width="100">
					Golden
				</th>
				<th class="hidden-xs hidden-sm hidden-md" width="100">
					Devil
				</th>
				<th class="hidden-xs hidden-sm hidden-md" width="200" colspan="2">
					World record
				</th>
				<th class="hidden-xs hidden-sm hidden-md" width="400" colspan="4">
					Completion rate
				</th>
			</tr>
		</thead>
		<tbody>
			@{
				foreach (CustomLeaderboard lb in Model.Leaderboards)
				{
					string fileName = lb.SpawnsetFileName;
					string name = SpawnsetFile.GetName(fileName);
					string author = SpawnsetFile.GetAuthor(fileName);
					List<CustomEntry> entries = Model.Entries.Where(e => e.CustomLeaderboard == lb).OrderByDescending(e => e.Time).ToList();
					string wrDagger = "";
					if (entries.Count > 0)
					{
						wrDagger = lb.GetDagger(entries[0].Time);
					}
					<tr>
						<td>
							<a asp-page="/CustomLeaderboards/Leaderboard" asp-route-spawnset="@fileName">@name</a>
						</td>
						<td>
							<a asp-page="/Spawnsets" asp-route-SearchAuthor="@author">@author</a>
						</td>
						<td class="text-right hidden-xs">
							@Model.Entries.Where(e => e.CustomLeaderboardID == lb.ID).Count()
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md bronze">
							@lb.Bronze.ToString("0.0000")
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md silver">
							@lb.Silver.ToString("0.0000")
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md golden">
							@lb.Golden.ToString("0.0000")
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md devil">
							@lb.Devil.ToString("0.0000")
						</td>
						<td class="@wrDagger hidden-xs hidden-sm hidden-md leaderboard-username">
							@{
								if (entries.Count == 0)
								{
									@:@RazorUtils.NAString
								}
								else
								{
									@entries[0].Username
								}
							}
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md @wrDagger">
							@{
								if (entries.Count > 0)
								{
									@entries[0].Time.ToString("0.0000")
								}
							}
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md bronze">
							@(entries.Count == 0 ? "0.00%" : (entries.Where(e => e.Time >= lb.Bronze).Count() / (float)entries.Count).ToString("0.00%"))
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md silver">
							@(entries.Count == 0 ? "0.00%" : (entries.Where(e => e.Time >= lb.Silver).Count() / (float)entries.Count).ToString("0.00%"))
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md golden">
							@(entries.Count == 0 ? "0.00%" : (entries.Where(e => e.Time >= lb.Golden).Count() / (float)entries.Count).ToString("0.00%"))
						</td>
						<td class="text-right hidden-xs hidden-sm hidden-md devil">
							@(entries.Count == 0 ? "0.00%" : (entries.Where(e => e.Time >= lb.Devil).Count() / (float)entries.Count).ToString("0.00%"))
						</td>
					</tr>
				}
			}
		</tbody>
	</table>

	<h2>FAQ</h2>
	<div class="faq-question">How do I participate?</div>
	<div class="faq-answer">
		You will need the Devil Daggers Custom Leaderboards program, also known as <a asp-page="/Tools/DevilDaggersCustomLeaderboards">DDCL</a>.<br />
		The program is not publicly available for download yet, but if you'd like to test, let me know on <a href="@RazorUtils.DiscordUrl">Discord</a>. Testing is much appreciated, as it helps me a lot making the program more stable.
	</div>

	<div class="faq-question">How do I get my spawnset a leaderboard?</div>
	<div class="faq-answer">
		If you think your spawnset should have a leaderboard, let me know. The spawnset should meet some requirements:<br />
		<ul>
			<li>Must have an endloop (spawnsets without an endloop, also known as "challenges", might get separate "leaderboards" (more like a list of people who have completed it) in the future).</li>
			<li>Must be more or less original (especially the endloop should be unique).</li>
			<li><span class="bronze" style="background-position-y: 3px;">Bronze</span>, <span class="silver" style="background-position-y: 3px;">Silver</span>, <span class="golden" style="background-position-y: 3px;">Golden</span>, and <span class="devil" style="background-position-y: 3px;">Devil</span> times should be specified and need to be possible, though you can make them very difficult to achieve if you wish.</li>
			<li>Optionally, you can specify an additional <span class="homing" style="background-position-y: 3px;">Homing</span> time (even though this is kind of a joke, the time should still be somewhat achievable).</li>
		</ul>
	</div>

	<div class="faq-question">How does it work?</div>
	<div class="faq-answer">
		The program constantly scans the 'dd.exe' process for certain values stored in memory.<br />
		It can detect a bunch of values, as well as which spawnset you're playing.<br />
		When the player dies, it uploads those values to a leaderboard based on the spawnset.<br />
		Sounds easy? It's actually pretty complicated, scanning another process's memory is not really a common task for an application. This is why DDCL might sometimes be unstable.<br />
		Testing helps me a lot, I'd like to thank everyone who helped testing DDCL, and I'd especially like to thank Bintr for helping me figure out and explaining how to do this in the first place.
	</div>

	<div class="faq-question">Source code?</div>
	<div class="faq-answer">
		Unfortunately I cannot share the source code since it would allow people to cheat the leaderboards.
	</div>
</main>

@section Styles {
	<link rel='stylesheet' href='~/styles/custom-leaderboards.css' />
}