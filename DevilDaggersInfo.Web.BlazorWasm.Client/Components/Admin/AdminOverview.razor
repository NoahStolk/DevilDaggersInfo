@typeparam TGetDto
@implements IHasNavigation
@inject AdminApiHttpClient Http
@inject AuthenticationStateProvider Auth
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using DevilDaggersInfo.Web.BlazorWasm.Client.Pages

<Heading Title="@Title" />

<Paragraph>Hello, @_username</Paragraph>

@if (_errorMessage != null)
{
	<ResultBar Title="Failed to retrieve overview" ResultBarType="ResultBarType.FatalError" DismissEvent="Dismiss">
		@_errorMessage
	</ResultBar>
}

@if (_page == null)
{
	<Loading />
}
else
{
	<Deletion AfterDelete="Fetch" ApiCall="@DeletionApiCall" @ref="_deletion" />

	<div class="bg-gray-1 p-2 text-lg">
		<a class="block w-24 mb-2 mx-1" href="@($"{NavigationManager.Uri}/add")">Add new</a>

		<CascadingValue Value="this">
			<Paging />
		</CascadingValue>
	</div>

	<div class="grid gap-2 @GridConfiguration">
		@foreach (KeyValuePair<PropertyInfo, bool> pi in _properties)
		{
			string name = (pi.Key.GetCustomAttribute(typeof(DisplayAttribute)) as DisplayAttribute)?.Name ?? pi.Key.Name;
			<a class="@(pi.Value ? "text-right" : "text-left") overflow-x-hidden" href="" @onclick="() => Sort(pi.Key.Name)" @onclick:preventDefault>@name</a>
		}
		<div></div>
		<div></div>
	</div>
	<div>
		@{
			int j = 0;
			foreach (TGetDto result in _page.Results)
			{
				<div class="grid gap-2 @GridConfiguration @(j++ % 2 == 0 ? "bg-gray-1" : string.Empty)">
					@foreach (KeyValuePair<PropertyInfo, bool> pi in _properties)
					{
						<div class="overflow-x-hidden @(pi.Value ? "text-right" : "text-left")">@ReflectionUtils.GetDtoPropertyDisplayValue(pi.Key, result)</div>
					}
					<div><a href="@($"{NavigationManager.Uri}/edit/{result.Id}")">Edit</a></div>
					<div><a href="" @onclick="() => _deletion?.Set(result.Id)" @onclick:preventDefault>Delete</a></div>
				</div>
			}
		}
	</div>
}

@code
{
	[Parameter, EditorRequired] public string Title { get; set; } = null!;
	[Parameter, EditorRequired] public Func<int, int, string?, bool, Task<Page<TGetDto>>> ApiCall { get; set; } = null!;
	[Parameter, EditorRequired] public Func<int, Task<HttpResponseMessage>> DeletionApiCall { get; set; } = null!;
	[Parameter, EditorRequired] public string GridConfiguration { get; set; } = null!;

	public int TotalPages => _page == null ? 0 : (_page.TotalResults - 1) / PageSize + 1;
	public int TotalResults => _page == null ? 0 : _page.TotalResults;

	public int PageIndex { get; set; }
	public int PageSize { get; set; } = PagingConstants.PageSizeDefault;
	private string? _sortBy;
	private bool _ascending = true;

	private Page<TGetDto>? _page;
	private string? _errorMessage;
	private Dictionary<PropertyInfo, bool> _properties = ReflectionUtils.GetDtoDisplayProperties<TGetDto>();
	private Dictionary<string, bool> _sortings = null!;

	private Deletion? _deletion;

	private string? _username;

	protected override async Task OnInitializedAsync()
	{
		AuthenticationState auth = await Auth.GetAuthenticationStateAsync();
		_username = auth.User?.Identity?.Name;

		if (_username?.Contains("unique_name: ") == true)
			_username = _username[("unique_name: ".Length)..];

		_sortings = _properties.ToDictionary(pi => pi.Key.Name, _ => true);
		await Fetch();
	}

	public async Task ChangePageIndex(int pageIndex)
	{
		PageIndex = Math.Clamp(pageIndex, 0, TotalPages - 1);
		await Fetch();
	}

	public async Task ChangePageSize(ChangeEventArgs e)
	{
		_ = int.TryParse(e.Value?.ToString(), out int pageSize);
		PageSize = pageSize;
		PageIndex = Math.Clamp(PageIndex, 0, TotalPages - 1);
		await Fetch();
	}

	private async Task Sort(string propertyName)
	{
		_sortBy = propertyName;
		_sortings[propertyName] = !_sortings[propertyName];
		_ascending = _sortings[propertyName];
		await Fetch();
	}

	private async Task Fetch()
	{
		try
		{
			_page = await ApiCall.Invoke(PageIndex, PageSize, _sortBy, _ascending);
			_errorMessage = null;
			StateHasChanged();
		}
		catch (AccessTokenNotAvailableException exception)
		{
			exception.Redirect();
		}
		catch (HttpRequestException ex)
		{
			if (ex.StatusCode.HasValue)
				_errorMessage = $"HTTP {(int)ex.StatusCode}: {ex.StatusCode}";
			else
				_errorMessage = $"An error occurred while sending the request. {ex.Message}";
		}
	}

	private void Dismiss()
	{
		_errorMessage = null;
		StateHasChanged();
	}
}
