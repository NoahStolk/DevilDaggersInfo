@page "/admin/spawnsets/add"
@using DevilDaggersInfo.Web.Shared.Dto.Admin.Spawnsets
@using DevilDaggersInfo.Web.Client.Components.Admin
@using DevilDaggersInfo.Web.Client.Enums
@using DevilDaggersInfo.Web.Shared.Dto.Admin.Players
@inherits BaseAdminPage

<AdminAdd Name="Spawnset" OverviewUrl="/admin/spawnsets" ApiCall="Http.AddSpawnset" Model="_addSpawnset" @ref="_addComponent">
	<InputWrapper Label="Author"><SearchDropdown TKey=int Values="@_playerNames" Converter="s => int.Parse(s)" @bind-Value="@_addSpawnset.PlayerId" /></InputWrapper>
	<InputWrapper Label="Name"><InputText class="admin-input" @bind-Value="@_addSpawnset.Name" /></InputWrapper>
	<InputWrapper Label="Max display waves"><InputNumber class="admin-input" @bind-Value="_addSpawnset.MaxDisplayWaves" /></InputWrapper>
	<InputWrapper Label="HTML description"><InputTextArea class="admin-input w-full h-64" @bind-Value="@_addSpawnset.HtmlDescription" /></InputWrapper>
	<InputWrapper Label="Practice"><InputCheckbox @bind-Value="@_addSpawnset.IsPractice" /></InputWrapper>
	<InputWrapper Label="File"><InputFile OnChange="LoadFile" /></InputWrapper>
</AdminAdd>

@code
{
	private Dictionary<int, string>? _playerNames;
	private AddSpawnset _addSpawnset = new();
	private AdminAdd<AddSpawnset> _addComponent = null!;

	protected override async Task OnInitializedAsync()
	{
		try
		{
			List<GetPlayerName> getPlayerNames = await Http.GetPlayerNames();
			_playerNames = getPlayerNames.ToDictionary(m => m.Id, m => m.PlayerName);

			_addComponent.State = ErrorState.None;
		}
		catch (HttpRequestException ex)
		{
			if (ex.StatusCode.HasValue)
				_addComponent.ErrorMessage = $"Error {(int)ex.StatusCode}: {ex.StatusCode}";
			else
				_addComponent.ErrorMessage = "An error occurred while sending the request.";

			_addComponent.State = ErrorState.FatalError;
		}
		catch (AccessTokenNotAvailableException exception)
		{
			exception.Redirect();
		}
	}

	private async Task LoadFile(InputFileChangeEventArgs e)
	{
		IBrowserFile file = e.File;
		using MemoryStream ms = new();
		await file.OpenReadStream().CopyToAsync(ms);

		_addSpawnset.FileContents = ms.ToArray();
	}
}
