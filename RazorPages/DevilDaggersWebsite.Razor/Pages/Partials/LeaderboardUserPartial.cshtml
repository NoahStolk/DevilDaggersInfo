@model IDefaultLeaderboardPageModel
@using DevilDaggersCore.Game
@using DevilDaggersWebsite.Entities
@using DevilDaggersWebsite.Razor.Models
@using DevilDaggersWebsite.Razor.PageModels
@using DevilDaggersWebsite.Razor.Pages.Leaderboard
@using Microsoft.EntityFrameworkCore
@inject DevilDaggersWebsite.Entities.ApplicationDbContext dbContext
@{
	bool isIndex = Model is IndexModel;
}

<div class="leaderboard-container flex-container flex-center">
	<div class="leaderboard-title-row flex-container">
		<div class="sorter text-right" sort="rank">#</div>
		<div class="sorter text-left" sort="flag">
			<span data-toggle='tooltip' title='Nationality (flag)'><img src="~/images/Icons/flag.png" /></span>
		</div>
		<div class="sorter text-left" sort="username">Username</div>
		<div class="sorter text-right" sort="time">Time</div>
		<div class="sorter hidden-xs text-right" sort="kills">Kills</div>
		<div class="sorter hidden-xs text-right" sort="gems">Gems</div>
		<div class="sorter hidden-xs text-right" sort="accuracy">Accuracy</div>
		<div class="sorter hidden-xs hidden-sm hidden-md text-left" sort="death-type">Death type</div>
		<div class="sorter hidden-xs hidden-sm hidden-md text-right" sort="total-time">Total time</div>
		<div class="sorter hidden-xs hidden-sm hidden-md text-right" sort="total-kills">Total kills</div>
		<div class="sorter hidden-xs hidden-sm hidden-md text-right" sort="total-gems">Total gems</div>
		<div class="sorter hidden-xs hidden-sm hidden-md text-right" sort="total-accuracy">Total accuracy</div>
		<div class="sorter hidden-xs hidden-sm hidden-md text-right" sort="total-deaths">Total deaths</div>
	</div>
	<div class="leaderboard-body">
		@{
			GameVersion gameVersion = GameInfo.GetGameVersionFromDate(Model.Leaderboard?.DateTime ?? DateTime.UtcNow) ?? GameVersion.V1;
			IEnumerable<Donation> donations = dbContext.Donations.AsNoTracking();
			List<Player> players = dbContext.Players.AsNoTracking().Include(p => p.PlayerTitles).ThenInclude(pt => pt.Title).ToList();
			foreach (Dto.Entry entry in Model.Leaderboard?.Entries.Take(100) ?? new List<Dto.Entry>())
			{
				Player? player = players.FirstOrDefault(p => p.Id == entry.Id);

				EntryModel em = new(entry, player, donations, !isIndex, gameVersion);

				<div class="sort @em.BanString" @em.HtmlData>
					<div class="leaderboard-row flex-container" id="@(entry.Rank)-row">
						@await Html.PartialAsync("Partials/EntryIdPartial", em)
						@await Html.PartialAsync("Partials/EntryFlagPartial", em)
						@await Html.PartialAsync("Partials/EntryUsernamePartial", em)
						<div class="text-right @em.DaggerColor">@em.Time</div>
						<div class="hidden-xs text-right">@em.Kills</div>
						<div class="hidden-xs text-right">@em.Gems</div>
						<div class="hidden-xs text-right">
							<span data-toggle="tooltip" title="@em.Daggers" class="leaderboard-tooltip">@em.Accuracy</span>
						</div>
						<div class="hidden-xs hidden-sm hidden-md text-left" style="@em.DeathStyle">@em.DeathName</div>
						<div class="hidden-xs hidden-sm hidden-md text-right">@em.TimeTotal</div>
						<div class="hidden-xs hidden-sm hidden-md text-right">@em.KillsTotal</div>
						<div class="hidden-xs hidden-sm hidden-md text-right">@em.GemsTotal</div>
						<div class="hidden-xs hidden-sm hidden-md text-right">
							<span data-toggle="tooltip" title="@em.DaggersTotal" class="leaderboard-tooltip">@em.AccuracyTotal</span>
						</div>
						<div class="hidden-xs hidden-sm hidden-md text-right">@em.DeathsTotal</div>
					</div>
					<div class="leaderboard-expand flex-container" id="@(entry.Rank)-expand">
						<div class="visible-xs">
							<div class="text-left">Kills</div>
							<div class="text-right">@em.Kills</div>
						</div>
						<div class="visible-xs">
							<div class="text-left">Gems</div>
							<div class="text-right">@em.Gems</div>
						</div>
						<div class="visible-xs">
							<div class="text-left">Accuracy</div>
							<div class="text-right">
								<span data-toggle="tooltip" title="@em.Daggers" class="leaderboard-tooltip">@em.Accuracy</span>
							</div>
						</div>
						<div class="visible-xs visible-sm visible-md">
							<div class="text-left">Death type</div>
							<div class="text-right" style="@em.DeathStyle">@(em.DeathName)</div>
						</div>
						<div class="visible-xs visible-sm visible-md">
							<div class="text-left">Total time</div>
							<div class="text-right">@em.TimeTotal</div>
						</div>
						<div class="visible-xs visible-sm visible-md">
							<div class="text-left">Total kills</div>
							<div class="text-right">@em.KillsTotal</div>
						</div>
						<div class="visible-xs visible-sm visible-md">
							<div class="text-left">Total gems</div>
							<div class="text-right">@em.GemsTotal</div>
						</div>
						<div class="visible-xs visible-sm visible-md">
							<div class="text-left">Total accuracy</div>
							<div class="text-right">
								<span data-toggle="tooltip" title="@em.DaggersTotal" class="leaderboard-tooltip">@em.AccuracyTotal</span>
							</div>
						</div>
						<div class="visible-xs visible-sm visible-md">
							<div class="text-left">Total deaths</div>
							<div class="text-right">@em.DeathsTotal</div>
						</div>
					</div>
				</div>
			}
		}
	</div>
</div>
